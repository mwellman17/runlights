require 'prawn'

class InstrumentSchedulePdf < Prawn::Document
  def initialize(instruments, show)
    super(top_margin: 70)
    @instruments = instruments.sort_by { |a| [a.position.nil? ? 1 : 0, a.position.blank? ? 1 : 0, a.position, a.unit_number ? 1 : 0, a.unit_number] }
    @show = show

    header
    instrument_schedule
    footer
  end

  def header
    fill_color "A67C00"
    text @show.name + " Instrument Schedule"
  end

  def instrument_schedule
    fill_color "000000"
    data = [[
      "Position",
      "Unit",
      "Fixture",
      "Purpose",
      "Chan",
      "Univ",
      "Addr",
      "Ckt Name",
      "Ckt#"
    ]]

    @instruments.each do |instrument|
      if instrument.unit_number && instrument.unit_number * 10 % 10 == 0
        unit_number = instrument.unit_number.floor
      else
        unit_number = instrument.unit_number
      end
      data += [[
        instrument.position,
        unit_number,
        instrument.fixture.name,
        instrument.purpose,
        instrument.channel,
        instrument.universe,
        instrument.address,
        instrument.circuit_name,
        instrument.circuit_number
      ]]
    end
    table(
      data,
      :header => true,
      :cell_style => { :borders => [:bottom] }
    )
  end

  def footer
    fill_color "A67C00"
    move_cursor_to 20
    text "Generated by RUNLIGHTS (pre-alpha)"
  end
end
